# 实验一：基于virtual box的网络攻防基础环境搭建

## 一、虚拟硬盘配置成多重加载

### 实验说明：

+ 实验环境：本次实验进行了多台虚拟机（后续实验所需系统）的设置，分别是两台Kali系统，两台xp系统，两台Debi an系统

  <img src="image\1.png" style="zoom:80%;" />


### 实验步骤：

+ 打开虚拟机管理

+ 进入虚拟介质管理

+ 选中对应虚拟硬盘，改为多重加载，释放盘片后重新加载虚拟硬盘即可

  <img src="image\2.png" />
  
  

---



## 二、搭建满足要求的虚拟机网络拓扑

### 实验说明：

+ 实验环境：本次实验需要用到六台虚拟机系统，分别为两台xp系统，两台Debian系统以及两台kali系统，一台kali作为攻击者，一台debian作为网关，剩下四台分在两个局域网内，均作为靶机。

+ 实验先修知识：一部分linux命令行的学习以及virtual box的五种网络类型的学习,以下是参考资料的链接，根据各种查询资料总结了下面一个表，表可能还需根据后续学习修改

  > [virtual box的网络类型]: https://blog.csdn.net/nailwl/article/details/48497099
  > [linux命令行]: https://man.linuxde.net/
  >
  > | 网络类型  | 虚拟机对主机的访问 | 主机对虚拟机的访问 | 虚拟机对其他主机的访问 | 其他主机对虚拟机的访问 |  虚拟机之间  |
  > | :-------: | :----------------: | :----------------: | :--------------------: | :--------------------: | :----------: |
  > |  NAT网络  |         √          |         ×          |           √            |           ×            |      ×       |
  > |   网桥    |         √          |         √          |           √            |           √            |      √       |
  > |   内网    |         ×          |         ×          |           ×            |           ×            | 同一网络可以 |
  > | Host-only |         ×          |         ×          |           ×            |           ×            |      √       |
  >
  > 

### 实验步骤：

+ 配置拓扑环境所需的网络：

  1. 网关所需网卡：NAT网络（为了使网关可以访问攻击者主机），Host-only网络（可以进行网卡的设置），两块内部网络（分别用于搭建两块独立的局域网）

  ​      <img src="image\3.png" />  

  2. 攻击者所需网卡：NAT网络，两块不同的Host-only网络

  ​      <img src="image\4.png" /> 

  3. victim（被攻击者）所需网卡：均为内部网络，使其分为两组，分别在不同的局域网内。

   <img src="image\5.png" />

   <img src="image\6.png" />

   <img src="image\7.png" />

   <img src="image\8.png" />

+ 由此，实验拓扑环境基本搭建完成，Victim-XP-1和Victim-Kali-1位于同一个局域网内,原因是它们的网卡均是intnet0，Victim-Debian-2和Victim-XP-2位于同一个局域网内,原因是它们的网卡均是intnet1，Debian作为这个网络环境的网关。另外，我们再次检测一下。

  1. 不同局域网内的网络层无法互ping:

    <img src="image\20.png" />

  2. 同一局域网内的网络层是可以互ping的,当然，这并不能完全说明这两台机器就在同一局域网内，我们在ping完后查看了Arp缓存后，发现能看到另一台机器的mac地址，根据计算机网络的知识，只有位于同一局域网内的机器进行交互时可以通过mac地址进行互相访问，而在访问外网时，需要通过网关来跨出局域网:

    <img src="image\21.png" />

    <img src="image\22.png" />

---



## 三、完成以下网络连通性测试

### 实验说明：（完成度）

- [x] 靶机可以直接访问攻击者主机
- [x] 攻击者主机无法直接访问靶机
- [x] 网关可以直接访问攻击者主机和靶机
- [x] 靶机的所有对外上下行流量必须经过网关
- [x] 所有节点均可以访问互联网

### 实验验证:

+ 靶机可以直接访问攻击者主机

  1. 为便于实验结果的观察，各个系统的ip地址和mac地址统计

  |       系统       |     ip地址     |         mac地址          |
  | :--------------: | :------------: | :----------------------: |
  |  Kali-Attacker   | 192.168.159.3  | fe80::a00:27ff:fede:3e05 |
  |   Victim-XP-1    | 172.16.111.127 |    08-00-27-A3-61-29     |
  |  Victim-Kali-1   | 172.16.111.133 |    08:00:27:8e:7d:fd     |
  |   Victim-XP-2    | 172.16.222.113 |    08-00-27-0C-47-1C     |
  | Victim-Debi an-2 | 172.16.222.124 |    08:00:27:68:a8:fe     |

  2. 进行ping检查网络层的连通性，发现靶机可以直接访问攻击者主机

     <img src="image\9.png" />

   

  3. 根据计算机网络分层知识，网络层连通，则下面的链路层、物理层也连通，由此证明，靶机可以直接访问攻击者主机。

  

  ---

  

+ 攻击者主机无法直接访问靶机

  1. 对靶机的ip地址进行ping以后发现均无法连通

     <img src="image\10.png"  />

     

  

  
2. 为证明并不是由于kali-Attacker上不了网而无法ping，进行了ping baidu，连通性正常

​     <img src="image\11.png" style="zoom:80%;" />



---



+ 网关可以直接访问攻击者主机和靶机（备注：由于重启重装了kali-Attacker,ip地址改变了，改为：192.168.56.104）

  

  1. 修改ip后的各个系统ip及mac地址情况

  |       系统       |     ip地址     |         mac地址          |
  | :--------------: | :------------: | :----------------------: |
  |  Kali-Attacker   | 192.168.56.104 | fe80::a00:27ff:fede:3e05 |
  |   Victim-XP-1    | 172.16.111.127 |    08-00-27-A3-61-29     |
  |  Victim-Kali-1   | 172.16.111.133 |    08:00:27:8e:7d:fd     |
  |   Victim-XP-2    | 172.16.222.113 |    08-00-27-0C-47-1C     |
  | Victim-Debi an-2 | 172.16.222.124 |    08:00:27:68:a8:fe     |

   2. 通过网关对攻击者和靶机进行ping，成功了，即说明网关可以直接访问攻击者主机和靶机。

    <img src="image\13.png" />



---



+ 靶机的所有对外上下行流量必须经过网关

  1. 说明：在靶机进行上互联网时，用网关进行抓包，如果靶机发出去的所有包都能被网关抓到，则说明靶机的所有对外上下行流量必须经过网关

  2. 为了能更清晰的看到ping的全过程，包括arp解析，dns解析等等包，先在靶机里清除一下arp缓存和dns缓存后再进行ping

     <img src="image\14.png" />

     3. 开始抓包并观察，发现靶机的上下行流量必须经过网关。另外，**当关闭网关时，发现靶机不再能上网**，则说明靶机的上下行流量必须经过网关。（通过参考老师推荐的验证后修改得到）

        + Victim-XP-1:

        <img src="image\15.png" />

        + Victim-Kali-1:

        <img src="image\16.png" />

          

        + Victim-XP-2:

        <img src="image\24.png" />

        + Victim-Debi an-2:

        <img src="image\17.png" />

        + **关闭网关后不再能访问网络，由图可知两台机器的ip地址是169开头的，是自动获取的，网关也不存在，更加力证了要求。**
  
          ![](image\victim-cannot-ping.png)
  
          
     
     
     
     

---



+ 所有节点均可以访问互联网

   <img src="image\18.png" />

   <img src="image\19.png" style="zoom:80%;" />          



---



## 四、遇到的问题

+ kali-Attacker无法上互联网，进行了以下命令的输入，配置进行了ip的分配后成功上网。
   ```
   grep "iface eth1 inet dhcp" /etc/network/interfaces || cat << EOF >> /etc/network/interfaces
   > auto eth0
   > iface eth0 inet dhcp
   > auto eth1
   > iface eth1 inet dhcp
   > EOF
   > systemctl restart networking
   ```

<img src="image\12.png" style="zoom:80%;" />



+ 网关无法访问xp系统，原因是：未关闭防火墙

+ 网关在抓包时抓不到arp的包，原因是：未清空arp缓存

+ 第一台Kali系统进行多重加载时遇到了问题：无法进行多重加载，后经过多次尝试及重装系统发现是由于备份的存在，把备份删掉以后多重加载成功。

+ debian系统中ifconfig以及arp等等命令均无法找到命令，输入下面命令进行配置上网工具以后解决了问题

  ```
  apt install net-tools
  ```

+ 

  <table><tr><td bgcolor=#dd0000>
     虽然两个局域网的主机均是内网模式，但是我通过网关同时ping了victim-xp-1和victim-xp-2两台机器后，在网关中查看arp缓存，发现两台机器的mac地址都有，假设处于内网无法访问的原因是由于网关找不到内网的地址，此时网关已经有它们的mac地址了，为什么还是无法互相访问呢？我猜测是不是因为不同网卡的arp缓存是不同的，而这里看到的是已经合并的arp缓存呢？
    原因：同一网关的不同网卡默认是不能互相访问的，我们通过设置网卡进行抓包的方式，可以看到对应的网卡可以抓到victim的包，但是不对应的网卡不能抓到包，因此这两个网卡不能互通。后续可以通过在网关中设置的方式使两台机器互通。</td></tr></table>
  
  <img src="image\23.png" />
  
  <img src="image\gateway-not.png" />
  
  
  
  <table>

---



## 五、实验总结（原因分析，根据老师的回复后修改）

+ 靶机可以直接访问攻击者主机（**通过老师的回复以后有所启发并修改了些原因**）

       网关使用了NAT模式，Nat相是把内网的IP映射为本机外网IP+端口。在这个实验中，靶机ping攻击者，ICMP Echo Request在经过网关时，网关会将其中的src ip改为自己的外网IP。所以从攻击者角度来看其实是『网关在ping我』。攻击者回复的ICMP Echo Reply在经过网关时，其中的src ip又会被网关改为攻击者的IP，所以从靶机角度来看就是『我能ping通攻击者』，虽然攻击者全程不知道有靶机这么个存在。

+ 攻击者主机无法直接访问靶机

       靶机处于内网，使用的ip地址是虚拟的，仅自己内部网络可用的地址，除本局域网以外的机器访问是无效的，根据计算机网络的知识，类似172.16开头的ip地址属于专用（内网）ip地址，攻击者甚至都不知道靶机的存在与否，因此，攻击者无法对其进行访问。

+ 网关可以直接访问攻击者主机和靶机

       靶机和攻击者的ip地址都是由网关进行分配的，上网功能也是由它提供的。因此，网关可以直接访问攻击者主机和靶机。

+ 靶机的所有对外上下行流量必须经过网关

       靶机上外网（局域网以外的网），需要通过网关获取其mac地址再根据指定的ip地址进行转发包。当然，如果是同一局域网内的靶机可以直接通过mac地址进行相互通信，不需要经过网关。

+ 所有节点均可以访问互联网

       均可以访问互联网。



